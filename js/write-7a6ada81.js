import{H as M}from"./rounded-button-f939e53f.js";import{M as O,T as H,P as $,S as B}from"./parse-content-a54c9f00.js";import{E}from"./toggle-aeefa9f6.js";import{y as m,t as D,T as F,V as L,_ as q,Q as z,J as A,R as W}from"./app-c79d7097.js";import{U as _}from"./underline-input-9e482305.js";import{k as j,h as J,e as Q}from"./use-store-ref-10b7967e.js";import{u as Y}from"./category-13d05545.js";import{c as G}from"./use-memo-fetch-data-list-839d9ef3.js";import{N as K}from"./DynamicTags-3037b51c.js";import{i as X}from"./isString-dd690eaa.js";import{d as N,o as h,a as Z,c as C,r as p,aa as ee,b as a,F as S,q as te}from"./create-injection-key-6dff4bbb.js";import{N as n}from"./FormItem-94ab7cfc.js";import{N as b}from"./Select-a912f9f4.js";import{N as x}from"./Switch-042989fd.js";import{N as ae}from"./InputNumber-8c89ecca.js";import"./Card-720de80b.js";import"./fade-in.cssr-c6d077ce.js";import"./preload-helper-f651ca80.js";import"./marked.esm-bfa291d5.js";import"./DatePicker-ccb0e8b7.js";import"./fade-in-height-expand.cssr-0f44db21.js";import"./light-feac2dab.js";import"./ChevronRight-d32dd5c3.js";import"./Forward-d74203eb.js";import"./Form-190bf06a.js";import"./light-8a4490bb.js";import"./light-7409aafd.js";import"./ButtonGroup-229638a3.js";import"./use-async-monaco-6421d120.js";import"./index-293d9537.js";import"./p-d5bd0779.js";import"./editor.main-b6230b8b.js";import"./editor.api-f9505e34.js";import"./monaco.contribution-88351d90.js";import"./use-save-confirm-ddeeb50f.js";import"./DynamicInput-1b1a5fbe.js";import"./_common-202f2abd.js";import"./Add-fbc91806.js";import"./Remove-125f6865.js";import"./vue.runtime.esm-bundler-7635bf69.js";import"./js-yaml-fb211b11.js";import"./use-react-df50bd4a.js";import"./props-f7a22bc2.js";import"./throttle-9e276cae.js";import"./Tag-945120fa.js";import"./_common-991711fd.js";import"./prop-8b8caa29.js";import"./light-b93dede2.js";import"./_common-6222e43f.js";const le=G(f=>m.api.posts.get({params:{page:f,size:50,select:"id title nid _id slug category categoryId"}})),Ze=N(()=>{const f=j(),u=J(Y);h(async()=>{await u.fetch()});const R=()=>({categoryId:u.data?.value?.[0].id??"",slug:"",text:"",title:"",copyright:!0,tags:[],summary:"",allowComment:!0,id:void 0,images:[],meta:void 0,pin:!1,pinOrder:1,relatedId:[],created:void 0}),T=e=>{const l=te(t),s=Object.keys(l);for(const o in e)s.includes(o)&&(t[o]=e[o])},r=le(),t=Z(R()),i=C(()=>f.query.id),g=C(()=>u.get(t.categoryId)||u.data?.value?.[0]||{});h(async()=>{const e=i.value;if(e&&typeof e=="string"){const l=await m.api.posts(e).get();l.data.relatedId=l.data.related?.map(s=>s.id)||[],r.append(l.data.related),T(l.data)}});const v=p(!1),w=D(),U=Q(),P=async()=>{const e={...t,categoryId:g.value.id,summary:t.summary&&t.summary.trim()!=""?t.summary.trim():null};if(i.value){if(!X(i.value))return;const l=i.value;await m.api.posts(l).put({data:e}),w.success("修改成功")}else await m.api.posts.post({data:e}),w.success("发布成功");U.push({name:W.ViewPost,hash:"|publish"})},V=()=>{v.value=!0,r.loading.value&&r.fetchNext()},k=e=>{const l=e.currentTarget;l.scrollTop+l.offsetHeight+10>=l.scrollHeight&&r.fetchNext()};return ee(()=>{r.refresh()}),()=>a(A,{title:i.value?"修改文章":"撰写新文章",actionsElement:a(S,null,[a($,{data:t,onHandleYamlParsedMeta:e=>{const{title:l,slug:s,...o}=e;t.title=l??t.title,t.slug=s??t.slug,t.meta={...o}}},null),a(M,{icon:a(q,null,null),onClick:P},null)]),footerButtonElement:a(S,null,[a("button",{onClick:V},[a(z,null,{default:()=>[a(B,null,null)]})])])},{default:()=>[a(O,{class:"mt-3 relative z-10",label:"想想取个什么标题好呢~",value:t.title,onChange:e=>{t.title=e}},null),a("div",{class:"text-gray-500 py-3"},[a("label",{class:"prefix"},[`${F}/${g.value.slug}/`]),a(_,{class:"ml-2",value:t.slug,onChange:e=>{t.slug=e}},null)]),a(E,{loading:!!(i.value&&typeof t.id>"u"),onChange:e=>{t.text=e},text:t.text},null),a(H,{show:v.value,onUpdateShow:e=>{v.value=e},data:t},{default:()=>[a(n,{label:"分类",required:!0,path:"category"},{default:()=>[a(b,{placeholder:"请选择",value:g.value.id,onUpdateValue:e=>{t.categoryId=e},options:u.data.value?.map(e=>({label:e.name,value:e.id,key:e.id}))||[]},null)]}),a(n,{label:"标签"},{default:()=>[a(K,{value:t.tags,onUpdateValue:e=>{t.tags.length=0,t.tags.push(...e)}},{input({submit:e}){return a(N({setup(){const s=p([]),o=p(!1),I=p(""),y=p();return h(async()=>{o.value=!0,y.value&&y.value.$el.querySelector("input").focus();const{data:d}=await m.api.categories.get({params:{type:"Tag"}});s.value=d.map(c=>({label:`${c.name} (${c.count})`,value:c.name,key:c.name})),o.value=!1}),()=>a(b,{ref:y,size:"small",value:I.value,clearable:!0,loading:o.value,filterable:!0,tag:!0,options:s.value,onUpdateValue:d=>{I.value=d,e(d)}},null)}}),null,null)}})]}),a(n,{label:"关联阅读"},{default:()=>[a(b,{maxTagCount:3,filterable:!0,clearable:!0,loading:r.loading.value,multiple:!0,onClear:()=>{r.refresh()},value:t.relatedId,onUpdateValue:e=>{t.relatedId=e},resetMenuOnOptionsChange:!1,options:r.datalist.value.map(e=>({label:e.title,value:e.id,key:e.id,disabled:e.id==t.id})),onScroll:k},null)]}),a(n,{label:"概要"},{default:()=>[a(L,{type:"textarea",autosize:{minRows:2,maxRows:4},placeholder:"文章概要",value:t.summary,onInput:e=>void(t.summary=e)},null)]}),a(n,{label:"版权注明",labelAlign:"right",labelPlacement:"left"},{default:()=>[a(x,{value:t.copyright,onUpdateValue:e=>void(t.copyright=e)},null)]}),a(n,{label:"置顶",labelAlign:"right",labelPlacement:"left"},{default:()=>[a(x,{value:!!t.pin,onUpdateValue:e=>{t.pin=e,e||(t.pinOrder=1)}},null)]}),a(n,{label:"置顶顺序",labelAlign:"right",labelPlacement:"left"},{default:()=>[a(ae,{disabled:!t.pin,value:t.pinOrder,onUpdateValue:e=>void(t.pinOrder=e||1)},null)]})]})]})});export{Ze as default};
