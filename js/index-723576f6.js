import{H as V}from"./rounded-button-6b29b554.js";import{q as G,R as Q,aj as w,a0 as D,x as f,g as W,J as X,aD as Y,K as Z}from"./app-5a2221a4.js";import{T as L}from"./index-9895a798.js";import{R as ee}from"./relative-time-740e13ad.js";import{u as ae}from"./use-table-fa04b674.js";import{o as te}from"./omit-6189749d.js";import{D as le,N as F,r as ue,f as re,g as ne}from"./use-store-ref-0fa0f74b.js";import{k as B,y as m,U as e,bq as se,aO as b,br as i,bs as ie,au as E,aq as oe,F as T,bM as de}from"./Button-5ec267f1.js";import{N as O}from"./Avatar-d9e68359.js";import{N as g}from"./FormItem-32059e79.js";import{N as R}from"./Select-410a3ac9.js";import{N as S}from"./Form-4f2beb1e.js";import{N as ce,a as k}from"./Tabs-b7519682.js";import{a as U}from"./Spin-2c3e5ca3.js";import{N as me}from"./Popconfirm-0c3d3f64.js";import{b as pe}from"./Card-73dd4072.js";import"./preload-helper-f651ca80.js";import"./DataTable-24c7be6c.js";import"./ChevronRight-54213128.js";import"./Checkbox-746a5c9b.js";import"./light-cfc8873a.js";import"./light-6dc94989.js";import"./light-6fe3aaa1.js";import"./light-1d805342.js";import"./light-efffb436.js";import"./Pagination-5b5faf1f.js";import"./Forward-414cae36.js";import"./prop-8b8caa29.js";import"./Tooltip-354350ce.js";import"./_baseClone-991b16dd.js";import"./utils-32451f97.js";import"./Tag-62076a6b.js";import"./_common-991711fd.js";import"./light-a3f8a6fb.js";import"./context-2fd66e76.js";import"./light-50e066bd.js";import"./Add-89af046c.js";import"./throttle-77fca6da.js";import"./light-a2e1a10d.js";import"./light-013cc201.js";var j=(t=>(t[t.Friend=0]="Friend",t[t.Collection=1]="Collection",t))(j||{}),s=(t=>(t[t.Pass=0]="Pass",t[t.Audit=1]="Audit",t[t.Outdate=2]="Outdate",t[t.Banned=3]="Banned",t[t.Reject=4]="Reject",t))(s||{});const $={Audit:"待审核",Pass:"通过",Outdate:"过时",Banned:"屏蔽",Reject:"拒绝"},_="https://fastly.jsdelivr.net/gh/mx-space/mx-admin@gh-pages/assets/fallback-2a34c29a.jpg";function z(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!se(t)}const H=B(t=>{const p=m(),c=m(!1),n=le(p,o=>{o[0].isIntersecting&&(c.value=!0,n.stop())});return()=>{let o,r;return e("div",{ref:p},[t.avatar?c.value?e(O,{src:t.avatar,round:!0,onError:C=>{console.log(_),C.target.src=_}},null):e(O,{round:!0},z(o=t.name.charAt(0))?o:{default:()=>[o]}):e(O,{round:!0},z(r=t.name.charAt(0))?r:{default:()=>[r]})])}});H.props=["avatar","name"];const ve=B({props:{onCallback:{type:Function,required:!0}},setup(t){const p=m(""),c=m(s.Pass),n=Object.entries($).filter(([r])=>r!=="Audit").map(([r,C])=>({value:s[r],key:r,label:C})),o=()=>{t.onCallback(c.value,p.value)};return()=>e(S,{class:"mt-6"},{default:()=>[e(g,{label:"状态"},{default:()=>[e(R,{value:c.value,onUpdateValue:r=>c.value=r,options:n},null)]}),e(g,{label:"原因"},{default:()=>[e(F,{type:"textarea",value:p.value,onUpdateValue:r=>p.value=r,placeholder:"请输入原因",maxlength:200,autosize:{maxRows:4,minRows:2}},null)]}),e("div",{class:"flex justify-end"},[e(b,{round:!0,type:"primary",onClick:o},{default:()=>[i("发送")]})])]})}}),fe=B({props:{url:String,errorMessage:String,status:[String,Number]},setup(t){return()=>e("div",{class:"flex space-x-2 items-center"},[e("a",{target:"_blank",href:t.url,rel:"noreferrer"},[t.url]),typeof t.status<"u"&&(t.errorMessage?e(ie,null,{trigger(){return e("div",{class:"h-2 w-2 bg-red-400 rounded-full"},null)},default(){return t.errorMessage}}):e("div",{class:"h-2 w-2 bg-green-300 rounded-full"},null))])}}),ta=B({setup(){const t=ue(),p=re(),c=m(t.query.state??s.Pass),{data:n,fetchDataFn:o,pager:r,loading:C}=ae((a,u)=>async(d=t.query.page||1,y=50)=>{const N=t.query.state??s.Pass,M=await f.api.links.get({params:{page:d,size:y,state:N|0}});a.value=M.data,u.value=M.pagination}),h=G(),A=()=>({avatar:"",name:"",type:j.Friend,url:"",id:null,description:"",state:s.Pass}),x=m(!1),l=m(A());E(()=>t.query.state,async a=>{await o()}),E(()=>t.query.page,async a=>{await o()},{immediate:!0});const v=m({}),q=async()=>{const a=await f.api.links.state.get();v.value=a};oe(()=>{q()});const J=async()=>{const a=l.value.id;if(a){const u=await f.api.links(a).put({data:te(l.value,["id","created","hide"])}),d=n.value.findIndex(y=>y.id==a);u.state!=c.value?(n.value.splice(d,1),q()):n.value[d]={...n.value[d],...de(l.value)}}else{const{data:u}=await f.api.links.post({data:{...l.value}});n.value.unshift(u)}h.success("操作成功"),x.value=!1,l.value=A()},I=m(),K=async()=>{const a=h.loading("检查中",{duration:2e5});try{const u=await f.api.links.health.get({timeout:2e5});I.value=Object.entries(u).reduce((d,[y,N])=>({...d,[y.toLowerCase()]:N}),{}),h.success("检查完成")}catch(u){console.error(u)}finally{requestAnimationFrame(()=>{a.destroy()})}},P=ne();return()=>e(Z,{actionsElement:e(T,null,[e(V,{icon:e(X,null,null),variant:"primary",onClick:()=>{l.value=A(),x.value=!0}},null),e(V,{icon:e(Y,null,null),variant:"info",onClick:K,name:"检查友链可用性"},null)])},{default:()=>[e(ce,{class:"min-h-[30px]",size:"medium",value:c.value,onUpdateValue:a=>{c.value=a,p.replace({name:Q.Friend,query:{state:a}})}},{default:()=>[e(k,{name:s.Pass,tab:"朋友们"},null),e(k,{name:s.Audit,tab:()=>e(w,{value:v.value.audit,processing:!0},{default:()=>[e(D,null,{default:()=>[i("待审核")]})]})},null),e(k,{name:s.Outdate,tab:()=>e(w,{value:v.value.outdate,type:"info"},{default:()=>[e(D,null,{default:()=>[i("过时的")]})]})},null),e(k,{name:s.Reject,tab:()=>e(w,{value:v.value.reject,type:"warning"},{default:()=>[e(D,null,{default:()=>[i("已拒绝")]})]})},null),e(k,{name:s.Banned,tab:()=>e(w,{value:v.value.banned,type:"error"},{default:()=>[e(D,null,{default:()=>[i("封禁的")]})]})},null)]}),e(L,{loading:C.value,data:n,nTableProps:{maxHeight:"calc(100vh - 22rem)"},columns:[{title:"头像",key:"avatar",width:80,render(a){return e(H,{name:a.name,avatar:a.avatar},null)}},{title:"名称",key:"name",render(a){return e("a",{target:"_blank",href:a.url,rel:"noreferrer"},[a.name])}},{title:"描述",key:"description",width:250,ellipsis:{lineClamp:2,tooltip:!0}},{title:"网址",key:"url",render(a){const u=I.value?.[a.id];return e(fe,{url:a.url,errorMessage:u?.message,status:u?.status},null)}},{title:"类型",key:"type",width:80,render(a){return["朋友","收藏"][a.type|0]}},{title:"对方邮箱",key:"email",render(a){return e("a",{href:`mailto:${a.email}`},[a.email])}},{title:"结识时间",key:"created",width:80,render(a){return e(ee,{time:a.created},null)}},{width:150,title:"操作",fixed:"right",key:"action",render(a){return e(U,{wrap:!1},{default:()=>[a.state==s.Audit&&e(T,null,[e(b,{text:!0,size:"tiny",type:"success",onClick:async()=>{await f.api.links.audit(a.id).patch(),h.success(`通过了来自${a.name}的友链邀请`);const u=n.value.findIndex(d=>d.id==a.id);n.value.splice(u,1),v.value.audit--}},{default:()=>[i("通过")]}),e(b,{text:!0,size:"tiny",type:"info",onClick:async()=>{P.create({title:"发送友链结果",closeOnEsc:!0,closable:!0,content:()=>e(ve,{onCallback:async(u,d)=>{await f.api.links.audit.reason(a.id).post({data:{state:u,reason:d}}),h.success(`已发送友链结果给「${a.name}」`);const y=n.value.findIndex(N=>N.id==a.id);n.value.splice(y,1),v.value.audit--,P.destroyAll()}},null)})}},{default:()=>[i("理由")]})]),e(b,{text:!0,size:"tiny",type:"info",onClick:u=>{x.value=!0,l.value={...a}}},{default:()=>[i("编辑")]}),e(me,{positiveText:"取消",negativeText:"删除",onNegativeClick:async()=>{await f.api.links(a.id).delete(),h.success("删除成功"),await o(r.value.currentPage),a.state==s.Audit&&v.value.audit--}},{trigger:()=>e(b,{text:!0,type:"error",size:"tiny"},{default:()=>[i("移除")]}),default:()=>e("span",{class:"max-w-48"},[i("确定要删除友链 "),a.name,i(" ?")])})]})}}],onFetchData:o,pager:r},null),e(W,{transformOrigin:"center",show:x.value,onUpdateShow:a=>void(x.value=a)},{default:()=>[e(pe,{style:"width: 500px;max-width: 90vw",headerStyle:{textAlign:"center"},title:l.value.id?`编辑: ${l.value.name}`:"新增"},{default:()=>[e(S,null,{default:()=>[e(g,{label:"名字",required:!0},{default:()=>[e(F,{autofocus:!0,value:l.value.name,onInput:a=>void(l.value.name=a)},null)]}),e(g,{label:"头像"},{default:()=>[e(F,{autofocus:!0,value:l.value.avatar,onInput:a=>void(l.value.avatar=a)},null)]}),e(g,{label:"网址",required:!0},{default:()=>[e(F,{autofocus:!0,value:l.value.url,onInput:a=>void(l.value.url=a)},null)]}),e(g,{label:"描述"},{default:()=>[e(F,{autofocus:!0,value:l.value.description,onInput:a=>void(l.value.description=a)},null)]}),e(g,{label:"类型"},{default:()=>[e(R,{placeholder:"选择类型",options:[{label:"朋友",value:j.Friend},{label:"收藏",value:j.Collection}],value:l.value.type,onUpdateValue:a=>void(l.value.type=a|0)},null)]}),l.value.id&&e(g,{label:"状态"},{default:()=>[e(R,{placeholder:"选择状态",options:Object.entries($).map(([a,u])=>({label:u,value:s[a]})),value:l.value.state,onUpdateValue:a=>void(l.value.state=a|0)},null)]})]}),e("div",{class:"text-right"},[e(U,{size:12,align:"center",inline:!0},{default:()=>[e(b,{type:"success",onClick:J,round:!0},{default:()=>[i("确定")]}),e(b,{onClick:()=>{x.value=!1,l.value=A()},round:!0},{default:()=>[i("取消")]})]})])]})]})]})}});export{ta as default};
