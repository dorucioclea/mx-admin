import{H as M}from"./rounded-button-f939e53f.js";import{V as F,t as ee,R as ae,an as w,a1 as D,y as f,h as te,H as le,aI as ue,J as ne}from"./app-c79d7097.js";import{T as re}from"./index-2c962807.js";import{R as se}from"./relative-time-0cb5a8b0.js";import{u as oe}from"./use-table-17c69ba1.js";import{o as ie}from"./omit-47b0e840.js";import{t as de,k as ce,e as ve,f as me}from"./use-store-ref-10b7967e.js";import{d as j,r as v,b as a,ap as pe,Z as o,ab as U,a1 as fe,F as E,q as ge}from"./create-injection-key-6dff4bbb.js";import{N as B}from"./Avatar-bfec934f.js";import{N as g}from"./FormItem-94ab7cfc.js";import{N as I}from"./Select-a912f9f4.js";import{Z as y,ag as he,a8 as ye}from"./Card-720de80b.js";import{N as K}from"./Form-190bf06a.js";import{N as be,a as C}from"./Tabs-8be888cd.js";import{b as _}from"./p-d5bd0779.js";import{N as Ne}from"./Popconfirm-8705d822.js";import"./fade-in.cssr-c6d077ce.js";import"./preload-helper-f651ca80.js";import"./DataTable-ee8322e1.js";import"./ChevronRight-d32dd5c3.js";import"./Checkbox-130849a4.js";import"./light-4a540c7a.js";import"./light-dcf71249.js";import"./light-758cc2d5.js";import"./light-b93dede2.js";import"./light-806b66fd.js";import"./Pagination-b72c8488.js";import"./Forward-d74203eb.js";import"./prop-8b8caa29.js";import"./Tooltip-e8ef26b6.js";import"./_baseClone-0362317e.js";import"./utils-8fb188d9.js";import"./Tag-945120fa.js";import"./_common-991711fd.js";import"./light-9254275d.js";import"./light-8a4490bb.js";import"./Add-fbc91806.js";import"./throttle-9e276cae.js";import"./light-64b8c660.js";import"./light-432a397e.js";var z;(function(e){e[e.Category=0]="Category",e[e.Tag=1]="Tag"})(z||(z={}));var H;(function(e){e[e.Post=0]="Post",e[e.Note=1]="Note"})(H||(H={}));var $;(function(e){e.Page="Page",e.Post="Post",e.Note="Note"})($||($={}));var J;(function(e){e[e.Unread=0]="Unread",e[e.Read=1]="Read",e[e.Junk=2]="Junk"})(J||(J={}));var A;(function(e){e[e.Friend=0]="Friend",e[e.Collection=1]="Collection"})(A||(A={}));var r;(function(e){e[e.Pass=0]="Pass",e[e.Audit=1]="Audit",e[e.Outdate=2]="Outdate",e[e.Banned=3]="Banned",e[e.Reject=4]="Reject"})(r||(r={}));var S;(function(e){e.md="md",e.html="html",e.frame="frame"})(S||(S={}));var T;(function(e){e.Post="Post",e.Note="Note",e.Page="Page"})(T||(T={}));var Z;(function(e){e.JSON="json",e.Function="function",e.Text="text",e.YAML="yaml"})(Z||(Z={}));const Q={Audit:"待审核",Pass:"通过",Outdate:"过时",Banned:"屏蔽",Reject:"拒绝"},Y="https://fastly.jsdelivr.net/gh/mx-space/mx-admin@gh-pages/assets/fallback-2a34c29a.jpg";function G(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!pe(e)}const W=j(e=>{const m=v(),c=v(!1),s=de(m,i=>{i[0].isIntersecting&&(c.value=!0,s.stop())});return()=>{let i,n;return a("div",{ref:m},[e.avatar?c.value?a(B,{src:e.avatar,round:!0,onError:x=>{console.log(Y),x.target.src=Y}},null):a(B,{round:!0},G(i=e.name.charAt(0))?i:{default:()=>[i]}):a(B,{round:!0},G(n=e.name.charAt(0))?n:{default:()=>[n]})])}});W.props=["avatar","name"];const xe=j({props:{onCallback:{type:Function,required:!0}},setup(e){const m=v(""),c=v(r.Pass),s=Object.entries(Q).filter(([n])=>n!=="Audit").map(([n,x])=>({value:r[n],key:n,label:x})),i=()=>{e.onCallback(c.value,m.value)};return()=>a(K,{class:"mt-6"},{default:()=>[a(g,{label:"状态"},{default:()=>[a(I,{value:c.value,onUpdateValue:n=>c.value=n,options:s},null)]}),a(g,{label:"原因"},{default:()=>[a(F,{type:"textarea",value:m.value,onUpdateValue:n=>m.value=n,placeholder:"请输入原因",maxlength:200,autosize:{maxRows:4,minRows:2}},null)]}),a("div",{class:"flex justify-end"},[a(y,{round:!0,type:"primary",onClick:i},{default:()=>[o("发送")]})])]})}}),ke=j({props:{url:String,errorMessage:String,status:[String,Number]},setup(e){return()=>a("div",{class:"flex space-x-2 items-center"},[a("a",{target:"_blank",href:e.url,rel:"noreferrer"},[e.url]),typeof e.status<"u"&&(e.errorMessage?a(he,null,{trigger(){return a("div",{class:"h-2 w-2 bg-red-400 rounded-full"},null)},default(){return e.errorMessage}}):a("div",{class:"h-2 w-2 bg-green-300 rounded-full"},null))])}}),ia=j({setup(){const e=ce(),m=ve(),c=v(e.query.state??r.Pass),{data:s,fetchDataFn:i,pager:n,loading:x}=oe((t,u)=>async(d=e.query.page||1,h=50)=>{const k=e.query.state??r.Pass,q=await f.api.links.get({params:{page:d,size:h,state:k|0}});t.value=q.data,u.value=q.pagination}),b=ee(),P=()=>({avatar:"",name:"",type:A.Friend,url:"",id:null,description:"",state:r.Pass}),N=v(!1),l=v(P());U(()=>e.query.state,async t=>{await i()}),U(()=>e.query.page,async t=>{await i()},{immediate:!0});const p=v({}),O=async()=>{const t=await f.api.links.state.get();p.value=t};fe(()=>{O()});const X=async()=>{const t=l.value.id;if(t){const u=await f.api.links(t).put({data:ie(l.value,["id","created","hide"])}),d=s.value.findIndex(h=>h.id==t);u.state!=c.value?(s.value.splice(d,1),O()):s.value[d]={...s.value[d],...ge(l.value)}}else{const{data:u}=await f.api.links.post({data:{...l.value}});s.value.unshift(u)}b.success("操作成功"),N.value=!1,l.value=P()},R=v(),L=async()=>{const t=b.loading("检查中",{duration:2e5});try{const u=await f.api.links.health.get({timeout:2e5});R.value=Object.entries(u).reduce((d,[h,k])=>({...d,[h.toLowerCase()]:k}),{}),b.success("检查完成")}catch(u){console.error(u)}finally{requestAnimationFrame(()=>{t.destroy()})}},V=me();return()=>a(ne,{actionsElement:a(E,null,[a(M,{icon:a(le,null,null),variant:"primary",onClick:()=>{l.value=P(),N.value=!0}},null),a(M,{icon:a(ue,null,null),variant:"info",onClick:L,name:"检查友链可用性"},null)])},{default:()=>[a(be,{class:"min-h-[30px]",size:"medium",value:c.value,onUpdateValue:t=>{c.value=t,m.replace({name:ae.Friend,query:{state:t}})}},{default:()=>[a(C,{name:r.Pass,tab:"朋友们"},null),a(C,{name:r.Audit,tab:()=>a(w,{value:p.value.audit,processing:!0},{default:()=>[a(D,null,{default:()=>[o("待审核")]})]})},null),a(C,{name:r.Outdate,tab:()=>a(w,{value:p.value.outdate,type:"info"},{default:()=>[a(D,null,{default:()=>[o("过时的")]})]})},null),a(C,{name:r.Reject,tab:()=>a(w,{value:p.value.reject,type:"warning"},{default:()=>[a(D,null,{default:()=>[o("已拒绝")]})]})},null),a(C,{name:r.Banned,tab:()=>a(w,{value:p.value.banned,type:"error"},{default:()=>[a(D,null,{default:()=>[o("封禁的")]})]})},null)]}),a(re,{loading:x.value,data:s,nTableProps:{maxHeight:"calc(100vh - 22rem)"},columns:[{title:"头像",key:"avatar",width:80,render(t){return a(W,{name:t.name,avatar:t.avatar},null)}},{title:"名称",key:"name",render(t){return a("a",{target:"_blank",href:t.url,rel:"noreferrer"},[t.name])}},{title:"描述",key:"description",width:250,ellipsis:{lineClamp:2,tooltip:!0}},{title:"网址",key:"url",render(t){const u=R.value?.[t.id];return a(ke,{url:t.url,errorMessage:u?.message,status:u?.status},null)}},{title:"类型",key:"type",width:80,render(t){return["朋友","收藏"][t.type|0]}},{title:"对方邮箱",key:"email",render(t){return a("a",{href:`mailto:${t.email}`},[t.email])}},{title:"结识时间",key:"created",width:80,render(t){return a(se,{time:t.created},null)}},{width:150,title:"操作",fixed:"right",key:"action",render(t){return a(_,{wrap:!1},{default:()=>[t.state==r.Audit&&a(E,null,[a(y,{text:!0,size:"tiny",type:"success",onClick:async()=>{await f.api.links.audit(t.id).patch(),b.success(`通过了来自${t.name}的友链邀请`);const u=s.value.findIndex(d=>d.id==t.id);s.value.splice(u,1),p.value.audit--}},{default:()=>[o("通过")]}),a(y,{text:!0,size:"tiny",type:"info",onClick:async()=>{V.create({title:"发送友链结果",closeOnEsc:!0,closable:!0,content:()=>a(xe,{onCallback:async(u,d)=>{await f.api.links.audit.reason(t.id).post({data:{state:u,reason:d}}),b.success(`已发送友链结果给「${t.name}」`);const h=s.value.findIndex(k=>k.id==t.id);s.value.splice(h,1),p.value.audit--,V.destroyAll()}},null)})}},{default:()=>[o("理由")]})]),a(y,{text:!0,size:"tiny",type:"info",onClick:u=>{N.value=!0,l.value={...t}}},{default:()=>[o("编辑")]}),a(Ne,{positiveText:"取消",negativeText:"删除",onNegativeClick:async()=>{await f.api.links(t.id).delete(),b.success("删除成功"),await i(n.value.currentPage),t.state==r.Audit&&p.value.audit--}},{trigger:()=>a(y,{text:!0,type:"error",size:"tiny"},{default:()=>[o("移除")]}),default:()=>a("span",{class:"max-w-48"},[o("确定要删除友链 "),t.name,o(" ?")])})]})}}],onFetchData:i,pager:n},null),a(te,{transformOrigin:"center",show:N.value,onUpdateShow:t=>void(N.value=t)},{default:()=>[a(ye,{style:"width: 500px;max-width: 90vw",headerStyle:{textAlign:"center"},title:l.value.id?`编辑: ${l.value.name}`:"新增"},{default:()=>[a(K,null,{default:()=>[a(g,{label:"名字",required:!0},{default:()=>[a(F,{autofocus:!0,value:l.value.name,onInput:t=>void(l.value.name=t)},null)]}),a(g,{label:"头像"},{default:()=>[a(F,{autofocus:!0,value:l.value.avatar,onInput:t=>void(l.value.avatar=t)},null)]}),a(g,{label:"网址",required:!0},{default:()=>[a(F,{autofocus:!0,value:l.value.url,onInput:t=>void(l.value.url=t)},null)]}),a(g,{label:"描述"},{default:()=>[a(F,{autofocus:!0,value:l.value.description,onInput:t=>void(l.value.description=t)},null)]}),a(g,{label:"类型"},{default:()=>[a(I,{placeholder:"选择类型",options:[{label:"朋友",value:A.Friend},{label:"收藏",value:A.Collection}],value:l.value.type,onUpdateValue:t=>void(l.value.type=t|0)},null)]}),l.value.id&&a(g,{label:"状态"},{default:()=>[a(I,{placeholder:"选择状态",options:Object.entries(Q).map(([t,u])=>({label:u,value:r[t]})),value:l.value.state,onUpdateValue:t=>void(l.value.state=t|0)},null)]})]}),a("div",{class:"text-right"},[a(_,{size:12,align:"center",inline:!0},{default:()=>[a(y,{type:"success",onClick:X,round:!0},{default:()=>[o("确定")]}),a(y,{onClick:()=>{N.value=!1,l.value=P()},round:!0},{default:()=>[o("取消")]})]})])]})]})]})}});export{ia as default};
