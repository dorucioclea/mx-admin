import{H as L}from"./rounded-button-f939e53f.js";import{y as g,Q as T,h as I,ap as k,aq as w,H as q,V as y,K as J,ar as _,J as $}from"./app-c79d7097.js";import{u as W}from"./use-table-17c69ba1.js";import{e as Q,k as Z}from"./use-store-ref-10b7967e.js";import{I as G,b as K}from"./endpoint-d1ee6527.js";import{U as O}from"./index-44f52b11.js";import{c as X}from"./use-memo-fetch-data-list-839d9ef3.js";import{S as Y}from"./Search24Regular-da1e3915.js";import{N as ee}from"./Upload-98f221c9.js";import{N as P}from"./Avatar-bfec934f.js";import{a as te,N as ae}from"./Select-a912f9f4.js";import{N as U,a as D}from"./ListItem-3b929c0f.js";import{T as E}from"./Trash-ae70a891.js";import{N as j}from"./Pagination-b72c8488.js";import{d as S,r as m,b as e,Z as x,z as M,F as N,o as A,ap as B,ag as le,a as re,ab as V}from"./create-injection-key-6dff4bbb.js";import{Z as v,a8 as C}from"./Card-720de80b.js";import{N as z}from"./Popconfirm-8705d822.js";import{N as ne}from"./Form-190bf06a.js";import{N as b}from"./FormItem-94ab7cfc.js";import{N as ue}from"./ButtonGroup-229638a3.js";import"./fade-in.cssr-c6d077ce.js";import"./preload-helper-f651ca80.js";import"./p-d5bd0779.js";import"./Add-fbc91806.js";import"./light-c32ae781.js";import"./utils-8fb188d9.js";import"./light-806b66fd.js";import"./Tooltip-e8ef26b6.js";import"./fade-in-height-expand.cssr-0f44db21.js";import"./Tag-945120fa.js";import"./_common-991711fd.js";import"./light-9254275d.js";import"./light-b93dede2.js";import"./light-90743f8c.js";import"./Forward-d74203eb.js";import"./light-758cc2d5.js";import"./prop-8b8caa29.js";import"./light-432a397e.js";import"./light-8a4490bb.js";const R=a=>{if(!a)return"";const t=a.split(" ")[0];return t.length>4?a[0]:t},oe=X(a=>g.api.notes.get({params:{page:a,size:50,select:"nid title _id id"}}));function se(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!B(a)}const ie=S({props:{id:{type:String,required:!0}},setup(a){const t=m(!1),r=m(null),i=m([]),d=m(),p=m(!0),f=async()=>{t.value=!0;const u=await g.api.topics(a.id).get();r.value=u,await l(u.id)},l=async(u,n=1,o=5)=>{p.value=!0;const{data:s,pagination:h}=await g.api.notes.topics(u).get({params:{page:n,size:o}});return p.value=!1,i.value=s,d.value=h,{data:s,pagination:h}},c=async u=>{await g.api.notes(u).patch({data:{topicId:null}}),message.success("已移除文章的专栏引用");const n=i.value.findIndex(o=>o.id===u);-~n&&i.value.splice(n,1)};return()=>{let u;return e(N,null,[e(v,{size:"small",secondary:!0,onClick:f},{default:()=>[e(T,{class:"mr-1"},{default:()=>[e(Y,null,null)]}),x("详情")]}),e(I,{show:t.value,closable:!0,onClose:()=>{t.value=!1},closeOnEsc:!0,onUpdateShow:n=>{t.value=n}},{default:()=>[r.value?e(C,{closable:!0,role:"dialog",class:"modal-card md",title:`专栏 - ${r.value.name}`,onClose:()=>{t.value=!1}},{default:()=>[e(k,null,{avatar(){return e(O,{class:"p0",type:"icon",onFinish:n=>{const o=JSON.parse((n.event?.target).responseText);return n.file.url=o.url,r.value&&g.api.topics(r.value.id).patch({data:{icon:o.url}}).then(()=>{r.value&&(r.value.icon=o.url)}),n.file},onError:n=>{try{const o=JSON.parse((n.event?.target).responseText);message.warning(o.message)}catch{}return n.file}},{default:()=>[e(ee,null,{default:()=>[e(P,{size:60,class:"rounded-xl bg-transparent",src:r.value?.icon||void 0},{default:()=>[r.value?.icon?void 0:R(r.value?.name)]})]})]})},header(){return e("b",null,[r.value?.name])},"header-extra":function(){return e("span",{class:"opacity-80"},[r.value?.slug])},description(){return e("p",{class:"opacity-90 clamp-2 break-all"},[r.value?.introduce])},default(){return e("p",null,[r.value?.description])}}),p.value&&i.value.length==0?e(w,{animated:!0,class:"mt-2 h-[350px]"},null):e("div",{class:"mt-4"},[e("p",{class:"flex justify-between items-center"},[e("strong",null,[x("包含的文章：")]),e(ce,{topicId:r.value.id,onSuccess:()=>{M(()=>f())}},null)]),i.value.length===0&&e("div",{class:"h-[300px] flex items-center justify-center"},[e(te,{description:"这里还没有任何内容"},null)]),e(U,{bordered:!0,class:"mt-2"},se(u=i.value.map(n=>e(D,{key:n.id},{default(){return e("p",{class:"space-x-2 flex items-center"},[e("span",null,[n.title]),e(G,{path:K(n.id)},null)])},suffix(){return e(z,{onPositiveClick:()=>c(n.id)},{trigger(){return e(v,{circle:!0,tertiary:!0,type:"error"},{default:()=>[e(T,null,{default:()=>[e(E,null,null)]})]})},default(){return`是否移除此话题「${r.value?.name}」？`}})}})))?u:{default:()=>[u]}),e("div",{class:"flex justify-end"},[d.value&&e(j,{class:"mt-4",onUpdatePage:n=>{l(a.id,n)},page:d.value.currentPage,pageCount:d.value.totalPage},null)])])]}):e(C,{class:"modal-card md",role:"dialog",title:"专栏信息获取中"},{default:()=>[e("div",{class:"flex relative gap-2 "},[e(w,{animated:!0,circle:!0,width:60},null),e("div",{class:"flex-grow"},[e(w,{animated:!0,text:!0,repeat:3,class:"flex-grow"},null)])]),e(w,{animated:!0,repeat:2,class:"mt-2",text:!0},null)]})]})])}}}),ce=S({props:{topicId:{type:String,required:!0},onSuccess:{type:Function,required:!1}},setup(a){const t=m(!1),r=async()=>{const u=le(l);await Promise.all(u.map(n=>g.api.notes(n).patch({data:{topicId:a.topicId}}))),message.success("添加成功"),t.value=!1,a.onSuccess?.(u)},{refresh:i,fetchNext:d,datalist:p,loading:f}=oe(),l=m([]),c=u=>{const n=u.currentTarget;n.scrollTop+n.offsetHeight+10>=n.scrollHeight&&d()};return A(()=>{p.value.length===0&&d()}),()=>e(N,null,[e(v,{secondary:!0,type:"success",circle:!0,onClick:()=>{t.value=!0}},{default:()=>[e(T,null,{default:()=>[e(q,null,null)]})]}),e(I,{closable:!0,closeOnEsc:!0,show:t.value,onUpdateShow:u=>{t.value=u}},{default:()=>[e(C,{title:"哪些文章需要添加到专栏？",class:"modal-card sm"},{footer(){return e("div",{class:"text-right"},[e(v,{round:!0,type:"success",onClick:()=>r()},{default:()=>[x("添加！")]})])},default(){return e(ae,{maxTagCount:3,filterable:!0,clearable:!0,loading:f.value,multiple:!0,onClear:()=>{i()},value:l.value,onUpdateValue:u=>{l.value=u},resetMenuOnOptionsChange:!1,options:p.value.map(u=>({label:u.title,value:u.id,key:u.id})),onScroll:c},null)}})]})])}}),de=S({props:{show:{type:Boolean,required:!0},onClose:{type:Function,required:!0},id:{type:String,required:!1},onSubmit:{type:Function,required:!1}},setup(a){const t=re({}),r=m(!1),i=()=>{Object.keys(t).forEach(l=>{delete t[l]})};V(()=>a.id,l=>{l?(r.value=!0,g.api.topics(l).get().then(c=>{Object.assign(t,c),r.value=!1})):i()});const d=()=>{a.onClose()},p=()=>{f?.value?.validate(async c=>{c?.length||await l()});async function l(){let c;a.id?(c=await g.api.topics(a.id).put({data:t}),message.success("修改成功")):(c=await g.api.topics.post({data:t}),message.success("添加成功")),a.onSubmit?.(c),M(()=>{i()})}},f=m();return()=>e(N,null,[e(I,{show:a.show,onUpdateShow:d,closable:!0,onClose:d,transformOrigin:"center"},{default:()=>[e(C,{role:"dialog",title:"新建话题",closable:!0,onClose:d,class:"modal-card sm"},{default:()=>[e(ne,{labelPlacement:"top",ref:f,model:t,disabled:r.value},{default:()=>[e(b,{label:"名字",required:!0,rule:{max:50,required:!0,trigger:["blur","input"]},path:"name"},{default:()=>[e(y,{value:t.name,onUpdateValue:l=>{t.name=l}},null)]}),e(b,{label:"id",required:!0,rule:{required:!0,trigger:["blur","input"]},path:"slug"},{default:()=>[e(y,{value:t.slug,onUpdateValue:l=>{t.slug=l}},null)]}),e(b,{label:"简介",required:!0,rule:{max:100,required:!0,trigger:["blur","input"]},path:"introduce"},{default:()=>[e(y,{value:t.introduce,onUpdateValue:l=>{t.introduce=l}},null)]}),e(b,{label:"图标"},{default:()=>[e(y,{value:t.icon,onUpdateValue:l=>{t.icon=l}},{suffix(){return e(O,{class:"flex items-center",type:"icon",onFinish:l=>{const c=JSON.parse((l.event?.target).responseText);return l.file.url=c.url,t.icon=l.file.url,l.file}},{default:()=>[e(v,{text:!0},{default:()=>[e(J,null,{default:()=>[e(_,null,null)]})]})]})}})]}),e(b,{label:"长描述",rule:{max:500,trigger:["blur","input"]},path:"description"},{default:()=>[e(y,{type:"textarea",autosize:{maxRows:5,minRows:2},value:t.description,onUpdateValue:l=>{t.description=l}},null)]}),e("div",{class:"flex justify-end gap-2"},[e(v,{round:!0,type:"primary",onClick:p},{default:()=>[x("提交")]})])]})]})]})])}});function pe(a){return typeof a=="function"||Object.prototype.toString.call(a)==="[object Object]"&&!B(a)}const Xe=S({setup(){const a=Q(),t=Z();V(()=>t.query.page,o=>{r(o?+o:0)});const{fetchDataFn:r,data:i,pager:d}=W((o,s)=>async(h=parseInt(t.query.page)||1,H=20)=>{const F=await g.api.topics.get({page:h,size:H});return s.value=F.pagination,o.value=F.data,F});A(()=>r());const p=m(""),f=m(!1),l=()=>{f.value=!0,p.value=""},c=()=>{f.value=!1,p.value=""};return{pagination:d,topics:i,fetchTopic:r,handleAddTopic:l,editTopicId:p,showTopicModal:f,handleCloseModal:c,handleSubmit(o){c();const s=i.value.findIndex(h=>h.id===o.id);-~s?i.value[s]=o:i.value.push(o)},handleDelete:async o=>{await g.api.topics(o).delete(),r()},handleEdit:o=>{p.value=o,f.value=!0},route:t,router:a}},render(){const{pagination:a,topics:t,router:r,route:i,editTopicId:d,showTopicModal:p,handleAddTopic:f,handleCloseModal:l,handleSubmit:c,handleEdit:u,handleDelete:n}=this;return e($,null,{actions(){return e(N,null,[e(L,{icon:e(q,null,null),onClick:f,variant:"success"},null)])},default(){let o;return e(N,null,[e(U,{bordered:!0,class:"mb-4"},pe(o=t.map(s=>e(D,{key:s.id},{prefix(){return e(P,{"data-src":s.icon,class:`mt-2 ${s.icon&&"!bg-transparent"}`,circle:!0,size:50,src:s.icon||void 0},{default:()=>[s.icon?void 0:R(s.name)]})},suffix(){return e(ue,null,{default:()=>[e(v,{round:!0,onClick:()=>u(s.id)},{default:()=>[x("编辑")]}),e(z,{onPositiveClick:()=>n(s.id)},{default(){return`确定删除「${s.name}」？`},trigger(){return e(v,{circle:!0,tertiary:!0,type:"error"},{default:()=>[e(T,null,{default:()=>[e(E,null,null)]})]})}})]})},default(){return e(k,{title:s.name,description:s.introduce,titleExtra:s.slug},{default(){return s.description},footer(){return e(ie,{id:s.id},null)}})}})))?o:{default:()=>[o]}),a&&e("div",{class:"flex justify-end"},[e(j,{page:a.currentPage,onUpdatePage:s=>{r.replace({query:{...i.query,page:s},params:{...i.params}})},pageCount:a.totalPage,pageSize:a.size,showQuickJumper:!0},null)]),e(de,{onClose:l,show:Boolean(p||d),id:d,onSubmit:c},null)])}})}});export{Xe as default};
