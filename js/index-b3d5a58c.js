import{H as V}from"./rounded-button-69ddbb6f.js";import{q as te,R as le,aj as P,a0 as A,x as p,g as ue,J as ne,aD as re,K as se}from"./app-55917f23.js";import{T as oe}from"./index-36199ab4.js";import{R as ie}from"./relative-time-743ea1e3.js";import{u as de}from"./use-table-2d40e9b7.js";import{o as ce}from"./omit-76ec0d8c.js";import{D as ve,N as F,r as me,f as fe,g as pe}from"./use-store-ref-bbea8734.js";import{k as j,y as v,U as a,bq as ge,aO as b,br as o,bs as he,au as _,aq as be,F as z,by as ye}from"./Button-d9ff6831.js";import{N as I}from"./Avatar-1e763e7f.js";import{N as g}from"./FormItem-27b0faf6.js";import{N as O}from"./Select-3f013427.js";import{N as X}from"./Form-13db772c.js";import{N as Ne,a as C}from"./Tabs-759374df.js";import{a as R}from"./Spin-67ef750c.js";import{N as xe}from"./Popconfirm-61eb0c09.js";import{b as ke}from"./Card-078f747d.js";import"./preload-helper-f651ca80.js";import"./DataTable-f111a795.js";import"./ChevronRight-3cae61bb.js";import"./Checkbox-612ca05b.js";import"./light-94264382.js";import"./light-dd3cea04.js";import"./light-b3b5aedd.js";import"./light-4438dbc4.js";import"./light-13e296db.js";import"./Pagination-44b115f1.js";import"./Forward-222daf43.js";import"./prop-8b8caa29.js";import"./Tooltip-dcc32e1b.js";import"./_baseClone-8edd49aa.js";import"./utils-3043f3f7.js";import"./Tag-9a8c2162.js";import"./_common-991711fd.js";import"./light-919c509d.js";import"./context-92b11acc.js";import"./light-90037cf1.js";import"./Add-f1fa47b3.js";import"./throttle-ad3cf4c2.js";import"./light-2c0303ad.js";import"./light-b22b1983.js";var $;(function(e){e[e.Category=0]="Category",e[e.Tag=1]="Tag"})($||($={}));var E;(function(e){e[e.Inc=1]="Inc",e[e.Dec=-1]="Dec"})(E||(E={}));var H;(function(e){e[e.Up=0]="Up",e[e.Down=1]="Down"})(H||(H={}));var J;(function(e){e[e.Post=0]="Post",e[e.Note=1]="Note"})(J||(J={}));var S;(function(e){e.Page="Page",e.Post="Post",e.Note="Note"})(S||(S={}));var T;(function(e){e[e.Unread=0]="Unread",e[e.Read=1]="Read",e[e.Junk=2]="Junk"})(T||(T={}));var w;(function(e){e[e.Friend=0]="Friend",e[e.Collection=1]="Collection"})(w||(w={}));var r;(function(e){e[e.Pass=0]="Pass",e[e.Audit=1]="Audit",e[e.Outdate=2]="Outdate",e[e.Banned=3]="Banned",e[e.Reject=4]="Reject"})(r||(r={}));var K;(function(e){e.md="md",e.html="html",e.frame="frame"})(K||(K={}));var Y;(function(e){e.Post="Post",e.Note="Note",e.Page="Page"})(Y||(Y={}));var G;(function(e){e.JSON="json",e.Function="function",e.Text="text",e.YAML="yaml"})(G||(G={}));const Z={Audit:"待审核",Pass:"通过",Outdate:"过时",Banned:"屏蔽",Reject:"拒绝"},Q="https://fastly.jsdelivr.net/gh/mx-space/mx-admin@gh-pages/assets/fallback-2a34c29a.jpg";function W(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!ge(e)}const L=j(e=>{const m=v(),c=v(!1),s=ve(m,i=>{i[0].isIntersecting&&(c.value=!0,s.stop())});return()=>{let i,n;return a("div",{ref:m},[e.avatar?c.value?a(I,{src:e.avatar,round:!0,onError:x=>{console.log(Q),x.target.src=Q}},null):a(I,{round:!0},W(i=e.name.charAt(0))?i:{default:()=>[i]}):a(I,{round:!0},W(n=e.name.charAt(0))?n:{default:()=>[n]})])}});L.props=["avatar","name"];const Ce=j({props:{onCallback:{type:Function,required:!0}},setup(e){const m=v(""),c=v(r.Pass),s=Object.entries(Z).filter(([n])=>n!=="Audit").map(([n,x])=>({value:r[n],key:n,label:x})),i=()=>{e.onCallback(c.value,m.value)};return()=>a(X,{class:"mt-6"},{default:()=>[a(g,{label:"状态"},{default:()=>[a(O,{value:c.value,onUpdateValue:n=>c.value=n,options:s},null)]}),a(g,{label:"原因"},{default:()=>[a(F,{type:"textarea",value:m.value,onUpdateValue:n=>m.value=n,placeholder:"请输入原因",maxlength:200,autosize:{maxRows:4,minRows:2}},null)]}),a("div",{class:"flex justify-end"},[a(b,{round:!0,type:"primary",onClick:i},{default:()=>[o("发送")]})])]})}}),Fe=j({props:{url:String,errorMessage:String,status:[String,Number]},setup(e){return()=>a("div",{class:"flex space-x-2 items-center"},[a("a",{target:"_blank",href:e.url,rel:"noreferrer"},[e.url]),typeof e.status<"u"&&(e.errorMessage?a(he,null,{trigger(){return a("div",{class:"h-2 w-2 bg-red-400 rounded-full"},null)},default(){return e.errorMessage}}):a("div",{class:"h-2 w-2 bg-green-300 rounded-full"},null))])}}),ca=j({setup(){const e=me(),m=fe(),c=v(e.query.state??r.Pass),{data:s,fetchDataFn:i,pager:n,loading:x}=de((t,u)=>async(d=e.query.page||1,h=50)=>{const k=e.query.state??r.Pass,M=await p.api.links.get({params:{page:d,size:h,state:k|0}});t.value=M.data,u.value=M.pagination}),y=te(),D=()=>({avatar:"",name:"",type:w.Friend,url:"",id:null,description:"",state:r.Pass}),N=v(!1),l=v(D());_(()=>e.query.state,async t=>{await i()}),_(()=>e.query.page,async t=>{await i()},{immediate:!0});const f=v({}),B=async()=>{const t=await p.api.links.state.get();f.value=t};be(()=>{B()});const ee=async()=>{const t=l.value.id;if(t){const u=await p.api.links(t).put({data:ce(l.value,["id","created","hide"])}),d=s.value.findIndex(h=>h.id==t);u.state!=c.value?(s.value.splice(d,1),B()):s.value[d]={...s.value[d],...ye(l.value)}}else{const{data:u}=await p.api.links.post({data:{...l.value}});s.value.unshift(u)}y.success("操作成功"),N.value=!1,l.value=D()},q=v(),ae=async()=>{const t=y.loading("检查中",{duration:2e5});try{const u=await p.api.links.health.get({timeout:2e5});q.value=Object.entries(u).reduce((d,[h,k])=>({...d,[h.toLowerCase()]:k}),{}),y.success("检查完成")}catch(u){console.error(u)}finally{requestAnimationFrame(()=>{t.destroy()})}},U=pe();return()=>a(se,{actionsElement:a(z,null,[a(V,{icon:a(ne,null,null),variant:"primary",onClick:()=>{l.value=D(),N.value=!0}},null),a(V,{icon:a(re,null,null),variant:"info",onClick:ae,name:"检查友链可用性"},null)])},{default:()=>[a(Ne,{class:"min-h-[30px]",size:"medium",value:c.value,onUpdateValue:t=>{c.value=t,m.replace({name:le.Friend,query:{state:t}})}},{default:()=>[a(C,{name:r.Pass,tab:"朋友们"},null),a(C,{name:r.Audit,tab:()=>a(P,{value:f.value.audit,processing:!0},{default:()=>[a(A,null,{default:()=>[o("待审核")]})]})},null),a(C,{name:r.Outdate,tab:()=>a(P,{value:f.value.outdate,type:"info"},{default:()=>[a(A,null,{default:()=>[o("过时的")]})]})},null),a(C,{name:r.Reject,tab:()=>a(P,{value:f.value.reject,type:"warning"},{default:()=>[a(A,null,{default:()=>[o("已拒绝")]})]})},null),a(C,{name:r.Banned,tab:()=>a(P,{value:f.value.banned,type:"error"},{default:()=>[a(A,null,{default:()=>[o("封禁的")]})]})},null)]}),a(oe,{loading:x.value,data:s,nTableProps:{maxHeight:"calc(100vh - 22rem)"},columns:[{title:"头像",key:"avatar",width:80,render(t){return a(L,{name:t.name,avatar:t.avatar},null)}},{title:"名称",key:"name",render(t){return a("a",{target:"_blank",href:t.url,rel:"noreferrer"},[t.name])}},{title:"描述",key:"description",width:250,ellipsis:{lineClamp:2,tooltip:!0}},{title:"网址",key:"url",render(t){const u=q.value?.[t.id];return a(Fe,{url:t.url,errorMessage:u?.message,status:u?.status},null)}},{title:"类型",key:"type",width:80,render(t){return["朋友","收藏"][t.type|0]}},{title:"对方邮箱",key:"email",render(t){return a("a",{href:`mailto:${t.email}`},[t.email])}},{title:"结识时间",key:"created",width:80,render(t){return a(ie,{time:t.created},null)}},{width:150,title:"操作",fixed:"right",key:"action",render(t){return a(R,{wrap:!1},{default:()=>[t.state==r.Audit&&a(z,null,[a(b,{text:!0,size:"tiny",type:"success",onClick:async()=>{await p.api.links.audit(t.id).patch(),y.success(`通过了来自${t.name}的友链邀请`);const u=s.value.findIndex(d=>d.id==t.id);s.value.splice(u,1),f.value.audit--}},{default:()=>[o("通过")]}),a(b,{text:!0,size:"tiny",type:"info",onClick:async()=>{U.create({title:"发送友链结果",closeOnEsc:!0,closable:!0,content:()=>a(Ce,{onCallback:async(u,d)=>{await p.api.links.audit.reason(t.id).post({data:{state:u,reason:d}}),y.success(`已发送友链结果给「${t.name}」`);const h=s.value.findIndex(k=>k.id==t.id);s.value.splice(h,1),f.value.audit--,U.destroyAll()}},null)})}},{default:()=>[o("理由")]})]),a(b,{text:!0,size:"tiny",type:"info",onClick:u=>{N.value=!0,l.value={...t}}},{default:()=>[o("编辑")]}),a(xe,{positiveText:"取消",negativeText:"删除",onNegativeClick:async()=>{await p.api.links(t.id).delete(),y.success("删除成功"),await i(n.value.currentPage),t.state==r.Audit&&f.value.audit--}},{trigger:()=>a(b,{text:!0,type:"error",size:"tiny"},{default:()=>[o("移除")]}),default:()=>a("span",{class:"max-w-48"},[o("确定要删除友链 "),t.name,o(" ?")])})]})}}],onFetchData:i,pager:n},null),a(ue,{transformOrigin:"center",show:N.value,onUpdateShow:t=>void(N.value=t)},{default:()=>[a(ke,{style:"width: 500px;max-width: 90vw",headerStyle:{textAlign:"center"},title:l.value.id?`编辑: ${l.value.name}`:"新增"},{default:()=>[a(X,null,{default:()=>[a(g,{label:"名字",required:!0},{default:()=>[a(F,{autofocus:!0,value:l.value.name,onInput:t=>void(l.value.name=t)},null)]}),a(g,{label:"头像"},{default:()=>[a(F,{autofocus:!0,value:l.value.avatar,onInput:t=>void(l.value.avatar=t)},null)]}),a(g,{label:"网址",required:!0},{default:()=>[a(F,{autofocus:!0,value:l.value.url,onInput:t=>void(l.value.url=t)},null)]}),a(g,{label:"描述"},{default:()=>[a(F,{autofocus:!0,value:l.value.description,onInput:t=>void(l.value.description=t)},null)]}),a(g,{label:"类型"},{default:()=>[a(O,{placeholder:"选择类型",options:[{label:"朋友",value:w.Friend},{label:"收藏",value:w.Collection}],value:l.value.type,onUpdateValue:t=>void(l.value.type=t|0)},null)]}),l.value.id&&a(g,{label:"状态"},{default:()=>[a(O,{placeholder:"选择状态",options:Object.entries(Z).map(([t,u])=>({label:u,value:r[t]})),value:l.value.state,onUpdateValue:t=>void(l.value.state=t|0)},null)]})]}),a("div",{class:"text-right"},[a(R,{size:12,align:"center",inline:!0},{default:()=>[a(b,{type:"success",onClick:ee,round:!0},{default:()=>[o("确定")]}),a(b,{onClick:()=>{N.value=!1,l.value=D()},round:!0},{default:()=>[o("取消")]})]})])]})]})]})}});export{ca as default};
