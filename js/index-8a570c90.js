import{aL as ce,aM as de,a1 as D,aN as pe,V as g,a3 as me,y as f,aO as X,am as fe,av as Y,h as ve,Q as ye,H as be,M as ge,aP as he,z as ee,R as we,t as Ne,aQ as xe,aR as M,aS as Se,J as ke}from"./app-c79d7097.js";import{h as O,u as j,e as te,k as Ie}from"./use-store-ref-10b7967e.js";import{d as h,r as v,a3 as ae,c as x,p as Pe,a as I,ab as S,b as e,F as N,i as Ce,ap as le,o as q,aa as Te,a1 as ne,q as De,Z as m,ac as R,ag as Oe}from"./create-injection-key-6dff4bbb.js";import{R as K}from"./relative-time-0cb5a8b0.js";import{H as $}from"./rounded-button-f939e53f.js";import{aP as je,t as Fe,ap as A,Z as w,a8 as Ae}from"./Card-720de80b.js";import{N as re,a as U,b as Ve}from"./DatePicker-ccb0e8b7.js";import{N as P}from"./Form-190bf06a.js";import{b as C,d as V}from"./p-d5bd0779.js";import{N as d}from"./FormItem-94ab7cfc.js";import{N as Ee}from"./InputNumber-8c89ecca.js";import{N as se}from"./Switch-042989fd.js";import{N as Ue}from"./DynamicTags-3037b51c.js";import{_ as z}from"./CheckCircleOutlined-13d0d065.js";import{i as B}from"./isEmpty-c1f037e7.js";import{m as Be}from"./fade-in.cssr-c6d077ce.js";import{b as Le}from"./_baseClone-0362317e.js";import{N as L}from"./Popconfirm-8705d822.js";import{N as qe,a as Ke}from"./ListItem-3b929c0f.js";import{N as _e}from"./ButtonGroup-229638a3.js";import{a as Me}from"./DataTable-ee8322e1.js";import{K as Re}from"./index-829a83a2.js";import{U as $e}from"./index-44f52b11.js";import{N as ze}from"./Upload-98f221c9.js";import{N as Ge,a as E}from"./Tabs-8be888cd.js";import"./preload-helper-f651ca80.js";import"./fade-in-height-expand.cssr-0f44db21.js";import"./light-feac2dab.js";import"./ChevronRight-d32dd5c3.js";import"./Select-a912f9f4.js";import"./light-b93dede2.js";import"./Tag-945120fa.js";import"./_common-991711fd.js";import"./Forward-d74203eb.js";import"./light-8a4490bb.js";import"./Remove-125f6865.js";import"./Add-fbc91806.js";import"./_common-6222e43f.js";import"./prop-8b8caa29.js";import"./vue.runtime.esm-bundler-7635bf69.js";import"./light-432a397e.js";import"./light-90743f8c.js";import"./Checkbox-130849a4.js";import"./light-4a540c7a.js";import"./light-dcf71249.js";import"./light-758cc2d5.js";import"./light-806b66fd.js";import"./Pagination-b72c8488.js";import"./Tooltip-e8ef26b6.js";import"./DynamicInput-1b1a5fbe.js";import"./_common-202f2abd.js";import"./light-c32ae781.js";import"./utils-8fb188d9.js";import"./throttle-9e276cae.js";import"./light-64b8c660.js";function He(t){return je(Fe(t).toLowerCase())}var We=ce(function(t,r,n){return r=r.toLowerCase(),t+(n?He(r):r)});const Je=We;var Qe=1,Ze=4;function ue(t){return Le(t,Qe|Ze)}function G(t,r,n){return t==null?t:de(t,r,n)}const H=h({props:{condition:{type:[Boolean,Function],required:!0}},setup(t,{slots:r}){const n=()=>{if(typeof t.condition=="function"?t.condition():t.condition)return r.default?.()};return()=>n()}});function T(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!le(t)}const Xe="mt-6",Ye={class:Xe,labelPlacement:"left",labelAlign:"right",labelWidth:150,autocomplete:"do-not-autofill"},oe=Symbol("JSONSchemaFormInject"),et=h({props:{schema:{type:Object,required:!0},onValueChange:{type:Function,required:!1},initialValue:{type:Object,required:!0},getKey:{type:Function,required:!1,default:t=>t}},setup(t){const r=v(t.initialValue);ae(()=>{t.onValueChange?.(r.value)},{flush:"post"});const n=x(()=>t.schema.definitions),c=x(()=>new Map(Object.entries(t.schema.definitions)));Pe(oe,{schema:t.schema,definitions:c,getKey:t.getKey});const s=x(()=>Object.keys(n.value)),o=v([s.value[0]]),a=O(j),i=I(Ye);return S(()=>a.viewport.value.mobile,l=>{l?(i.labelPlacement="top",i.labelAlign="left"):(i.labelPlacement="left",i.labelAlign="right")},{immediate:!0}),()=>{let l,u;const{schema:p}=t;return e(N,null,[e(re,{accordion:!0,defaultExpandedNames:o.value,displayDirective:"if"},T(l=s.value.map(y=>{const b=n.value[y];return b.title?e(U,{title:b.title,"data-schema":JSON.stringify(b)},{default:()=>[e(P,i,{default:()=>[e(ie,{dataKey:t.getKey(y),formData:r,schema:b},null)]})]}):null}))?l:{default:()=>[l]}),p.ps.length?e(C,{vertical:!0},T(u=p.ps.map(y=>e(D,{class:"ml-4 mt-8 text-xs inline-block",depth:3},T(y)?y:{default:()=>[y]})))?u:{default:()=>[u]}):null])}}}),ie=h({props:{schema:{type:Object,required:!0},formData:{type:Object,required:!0},dataKey:{type:String,required:!0}},setup(t){const{definitions:r,getKey:n}=Ce(oe,{});return()=>{const{schema:c,formData:s,dataKey:o}=t;return c?e(N,null,[Object.keys(c.properties).map(a=>{const i=c.properties[a];if(i.$ref){const l=r.value.get(i.$ref.split("/").at(-1));return e(ie,{dataKey:`${n(o)}.${a}`,formData:s,schema:l},null)}return e(tt,{value:A(s.value,`${n(o)}.${a}`,void 0),onUpdateValue:l=>{A(s.value,n(o))?G(s.value,`${n(o)}.${a}`,l):G(s.value,n(o),{...A(s.value,n(o),{}),[a]:l})},title:i.title,type:i.type,options:i?.["ui:options"],description:i.description},null)})]):null}}}),tt=h({props:{type:{type:String,required:!0},title:{type:String,required:!0},description:{type:String},options:{type:Object,default:()=>({})},value:{type:Object,required:!0},onUpdateValue:{type:Function,required:!0}},setup(t){const r=v(t.value);ae(()=>{t.onUpdateValue(r.value)});const n=()=>{const{options:o}=t;switch(t.type){case"url":case"string":{const{type:a}=o;return e(g,{inputProps:{id:pe()},value:r.value,onUpdateValue:i=>{r.value=i},type:a||"text",showPasswordToggle:!0,autosize:a=="textarea"?{maxRows:5,minRows:3}:void 0,clearable:!0},null)}case"array":return e(Ue,{value:r.value,onUpdateValue:a=>{r.value=a}},null);case"boolean":return e(se,{value:r.value,onUpdateValue:a=>{r.value=a}},null);case"integer":return e(Ee,{value:r.value,onUpdateValue:a=>{r.value=a}},null);default:return null}},c=O(j),s=x(()=>c.viewport.value.mobile?1:2);return()=>{const{title:o,options:a,description:i}=t,l=e(N,null,[e(d,{label:o},{default:()=>[i?e(C,{vertical:!0},{default:()=>[n(),e(D,{class:"text-xs",depth:3},T(i)?i:{default:()=>[i]})]}):n()]})]);return a.halfGrid&&s.value===2?e("div",{class:"w-1/2 inline-block"},[l]):l}}}),at="mt-6",lt={class:at,labelPlacement:"left",labelAlign:"right",labelWidth:150,autocomplete:"chrome-off"},W={autosize:!0,clearable:!0,style:"min-width: 300px; max-width: 100%"},nt=h(()=>{const{setHeaderButtons:t}=me();q(()=>{t(e($,{disabled:!0,onClick:o,icon:e(z,null,null)},null))}),Te(()=>{t(null)});const r=v();ne(async()=>{r.value=await f.api.config.jsonschema.get({transform:!1}),await a()});let n={};const c=I({}),s=v({});S(()=>c,u=>{s.value=X(n,De(u))},{deep:!0}),S(()=>s.value,u=>{let p=!1;B(u)?p=!1:p=!0,t(e($,{disabled:!p,icon:e(z,null,null),onClick:o},null))});async function o(){if(B(s.value))return;const u=Object.entries(s.value);for await(const[p,y]of u){const b=Object.fromEntries(Object.entries(y).map(([F,_])=>Array.isArray(_)?[F,c[p][F]]:[F,_]));await f.api.options(p).patch({data:b})}await a(),message.success("修改成功")}const a=async()=>{let u=await f.api.options.get();u=Be(r.value.default,u),n=ue(u),Object.assign(c,u)},i=O(j),l=I(lt);return S(()=>i.viewport.value.mobile,u=>{u?(l.labelPlacement="top",l.labelAlign="left"):(l.labelPlacement="left",l.labelAlign="right")},{immediate:!0}),()=>e(N,null,[e("div",{class:"pt-4"},null),r.value&&e(et,{initialValue:c,getKey:u=>u.split(".").map(p=>Je(p)).join(".").replace("Dto",""),schema:r.value},null)])});function J(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!le(t)}const rt=h(()=>{const t=v([]),r=async()=>{const s=await f.api.user.session.get({});t.value=[...s.data]};q(()=>{r()});const n=async(s,o)=>{s?(await f.api.user.logout.post({}),ee(),window.location.reload()):(await f.api.user.session(o).delete({}),t.value=t.value.filter(a=>a.id!==o))},c=async()=>{await Promise.all(t.value.map(s=>{if(!s.current)return n(!1,s.id)})),await r()};return()=>{let s;return e(N,null,[e(fe,{class:"flex items-center justify-between"},{default:()=>[e("span",{class:"ml-4"},[m("登录设备")]),e(L,{onPositiveClick:c},{trigger(){return e(w,{size:"small",text:!0,type:"error",disabled:t.value.length==1&&t.value[0].current},{default:()=>[m("踢掉全部")]})},default(){return"确定踢掉全部登录设备（除当前会话）？"}})]}),e(qe,{bordered:!0},J(s=t.value.map(({id:o,ua:a,ip:i,date:l,current:u})=>e(Ke,{key:o},{prefix(){return e("div",{class:"w-20 text-center"},[u?"当前":null])},suffix(){return e(_e,null,{default:()=>[e(L,{onPositiveClick:()=>n(!!u,o)},{trigger(){return e(w,{tertiary:!0,type:"error"},{default:()=>[u?"注销":"踢"]})},default(){return u?"登出？":"确定要踢出吗？"}})]})},default(){return e(C,{vertical:!0},{default:()=>[e(H,{condition:!!a},{default:()=>[e(V,null,{default:()=>[m("User Agent: "),a]})]}),e(H,{condition:!!i},{default:()=>[e(V,null,{default:()=>[m("IP:")," ",e(Y,{ip:i,triggerEl:e(w,{text:!0,size:"tiny",type:"primary"},J(i)?i:{default:()=>[i]})},null)]})]}),e(V,null,{default:()=>[u?"活跃时间":"登录时间",m(":")," ",e(K,{time:l},null)]})]})}})))?s:{default:()=>[s]}),e("div",{class:"pt-4"},null),e(re,{defaultExpandedNames:[""],displayDirective:"show"},{default:()=>[e(U,{name:"reset",title:"修改密码"},{default:()=>[e(ut,null,null)]}),e(U,{name:"token",title:"API Token"},{default:()=>[e(st,null,null)]})]})])}}),st=h(()=>{const t=v([]),r=()=>({name:"",expired:!1,expiredTime:new Date}),n=I(r()),c=async()=>{const{data:l}=await f.api.auth.token.get();t.value=l};ne(()=>{c()});const s=v(!1),o=async()=>{const l={name:n.name,expired:n.expired?n.expiredTime.toISOString():void 0},u=await f.api.auth.token.post({data:l});await navigator.clipboard.writeText(u.token),s.value=!1;const p=r();for(const b in p)n[b]=p[b];message.success(`生成成功, Token 已复制, ${u.token}`),await c();const y=t.value.findIndex(b=>b.name===l.name);y!==-1&&(t.value[y].token=u.token)},a=async l=>{await f.api.auth.token.delete({params:{id:l}}),message.success("删除成功");const u=t.value.findIndex(p=>p.id===l);u!=-1&&t.value.splice(u,1)},i=O(j);return()=>e(he,{class:"!overflow-visible"},{default:()=>[e(ve,{transformOrigin:"center",show:s.value,onUpdateShow:l=>void(s.value=l)},{default:()=>[e(Ae,{bordered:!1,title:"创建 Token",class:"max-w-full w-[500px]"},{default:()=>[e(P,null,{default:()=>[e(d,{label:"名称",required:!0},{default:()=>[e(g,{value:n.name,onInput:l=>void(n.name=l)},null)]}),e(d,{label:"是否过期"},{default:()=>[e(se,{value:n.expired,onUpdateValue:l=>void(n.expired=l)},null)]}),e(d,{label:"过期时间"},{default:()=>[e(Ve,{disabled:!n.expired,value:n.expiredTime,type:"datetime",onUpdateValue:l=>void(n.expiredTime=new Date(l))},null)]})]}),e(C,null,{default:()=>[e(w,{round:!0,onClick:()=>void(s.value=!1)},{default:()=>[m("取消")]}),e(w,{round:!0,type:"primary",onClick:o},{default:()=>[m("确定")]})]})]})]}),e(w,{class:"absolute right-0 top-[-3rem]",round:!0,type:"primary",onClick:()=>{s.value=!0}},{default:()=>[e(ye,null,{default:()=>[e(be,null,null)]}),e("span",{class:"ml-2"},[m("新增")])]}),e(Me,{scrollX:Math.max(800,i.contentWidth.value-i.contentInsetWidth.value),remote:!0,bordered:!1,data:t.value,columns:[{key:"name",title:"名称"},{key:"token",title:"Token",render({token:l}){return l??"*".repeat(40)}},{title:"创建时间",key:"created",render({created:l}){return e(K,{time:l},null)}},{title:"过期时间",key:"expired",render({expired:l}){return ge(l,"yyyy年M月d日 HH:mm:ss")}},{title:"操作",key:"id",render({id:l,name:u}){return e(C,null,{default:()=>[e(L,{positiveText:"取消",negativeText:"删除",onNegativeClick:()=>{a(l)}},{trigger:()=>e(w,{text:!0,type:"error"},{default:()=>[m("删除")]}),default:()=>e("span",{class:"max-w-48"},[m('确定要删除 Token "'),u,m('"?')])})]})}}]},null)]})}),ut=h(()=>{const t=I({password:"",reenteredPassword:""}),r=v(),n=te(),c=async()=>{r.value&&r.value.validate(async o=>{o?console.log(o):(await f.api.master.patch({data:{password:t.password}}),message.success("更改成功"),ee(),n.push({name:we.Login}))})};function s(o,a){return console.log(o),a===t.password}return()=>e(P,{class:"max-w-[300px]",ref:r,model:t,rules:{password:[{required:!0,message:"请输入密码"}],reenteredPassword:[{required:!0,message:"请再次输入密码",trigger:["input","blur"]},{validator:s,message:"两次密码输入不一致",trigger:["blur","password-input"]}]}},{default:()=>[e(d,{label:"新密码",required:!0,path:"password"},{default:()=>[e(g,R(W,{value:t.password,onInput:o=>void(t.password=o),type:"password"}),null)]}),e(d,{label:"重复密码",required:!0,path:"reenteredPassword"},{default:()=>[e(g,R(W,{value:t.reenteredPassword,onInput:o=>void(t.reenteredPassword=o),type:"password"}),null)]}),e("div",{class:"w-full text-right"},[e(w,{onClick:c,type:"primary",round:!0},{default:()=>[m("保存")]})])]})}),Q={GitHub:"github",Weibo:"weibo",网易云:"netease",哔哩哔哩:"bilibili"},ot="_avatar_7rrjr_3",Z={"tab-user":"_tab-user_7rrjr_1",avatar:ot},it=h(()=>{const t=v({});let r;async function n(){const a=await f.api.master.get();t.value=a,r={...a}}q(async()=>{await n()});const c=Ne(),s=x(()=>X(r,t.value)),o=async()=>{const a=ue(Oe(s));a.socialIds&&(a.socialIds=t.value.socialIds),await f.api.master.patch({data:a}),c.success("保存成功~"),await n()};return()=>e(N,null,[e(xe,{cols:"1 400:1 600:2",class:Z["tab-user"],xGap:20,yGap:20},{default:()=>[e(M,null,{default:()=>[e(P,{class:"flex flex-col justify-center items-center "},{default:()=>[e(d,null,{default:()=>[e("div",{class:Z.avatar},[e($e,{type:"avatar",onFinish:a=>{const{file:i,event:l}=a;try{const u=JSON.parse((l?.target).responseText);t.value.avatar=u.url}catch{}return i}},{default:()=>[e(ze,{class:"border-0 bg-transparent hover:border-0"},{default:()=>[e(Se,{class:"flex",src:t.value.avatar,size:200},null)]})]})])]}),e(d,{label:"上次登录时间",class:"!mt-4"},{default:()=>[e("div",{class:"text-center w-full"},[e(D,null,{default:()=>[t.value.lastLoginTime?e(K,{time:t.value.lastLoginTime},null):"N/A"]})])]}),e(d,{label:"上次登录地址"},{default:()=>[e("div",{class:"text-center w-full"},[t.value.lastLoginIp?e(Y,{trigger:"hover",ip:t.value.lastLoginIp,triggerEl:e(D,{class:"cursor-pointer"},{default:()=>[t.value.lastLoginIp]})},null):"N/A"])]}),e(d,null,{default:()=>[e(w,{round:!0,class:"-mt-14",type:"primary",onClick:o,disabled:B(s.value)},{default:()=>[m("保存")]})]})]})]}),e(M,null,{default:()=>[e(P,null,{default:()=>[e(d,{label:"主人名 (username)"},{default:()=>[e(g,{value:t.value.username,onInput:a=>{t.value.username=a?.trim()||""}},null)]}),e(d,{label:"主人昵称 (name)"},{default:()=>[e(g,{value:t.value.name,onInput:a=>{t.value.name=a?.trim()||""}},null)]}),e(d,{label:"主人邮箱 (mail)"},{default:()=>[e(g,{value:t.value.mail,onInput:a=>{t.value.mail=a}},null)]}),e(d,{label:"个人首页"},{default:()=>[e(g,{value:t.value.url,onInput:a=>{t.value.url=a}},null)]}),e(d,{label:"头像"},{default:()=>[e(g,{value:t.value.avatar,onInput:a=>{t.value.avatar=a}},null)]}),e(d,{label:"个人介绍"},{default:()=>[e(g,{type:"textarea",resizable:!1,value:t.value.introduce,onInput:a=>{t.value.introduce=a}},null)]}),e(d,{label:"社交平台 ID 录入"},{default:()=>[e(Re,{options:Object.keys(Q).map(a=>({label:a,value:Q[a]})),onChange:a=>{t.value.socialIds=a},value:t.value.socialIds||{}},null)]})]})]})]})])});var k;(function(t){t.User="user",t.System="system",t.Security="security"})(k||(k={}));const da=h({setup(){const t=Ie(),r=te(),n=v(t.params.type);S(()=>t.params.type,s=>{s&&(n.value=s)});const c=v(null);return()=>e(ke,{actionsElement:c.value},{default:()=>[e(Ge,{value:n.value,onUpdateValue:s=>{r.replace({...t,params:{...t.params,type:s}})}},{default:()=>[e(E,{tab:"用户",name:k.User},{default:()=>[e(it,null,null)]}),e(E,{tab:"系统",name:k.System},{default:()=>[e(nt,null,null)]}),e(E,{tab:"安全",name:k.Security},{default:()=>[e(rt,null,null)]})]})]})}});export{da as default};
