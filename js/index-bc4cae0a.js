import{H as w}from"./rounded-button-f939e53f.js";import{t as M,F as P,G as x,b5 as A,b6 as D,J as F,V as H,y as I,M as v,av as V}from"./app-c79d7097.js";import{X as B}from"./index-2d02a5c3.js";import{u as b}from"./use-react-df50bd4a.js";import{l as R,b as c}from"./index-7c19d076.js";import{E as p}from"./types-a9f3cfbf.js";import{m as Y}from"./fade-in.cssr-c6d077ce.js";import{d as f,r as m,aa as T,ab as j,b as t,F as L,o as g,Z as d,ap as O}from"./create-injection-key-6dff4bbb.js";import{f as U}from"./use-store-ref-10b7967e.js";import{Z as C,a8 as _}from"./Card-720de80b.js";import{N as $}from"./Form-190bf06a.js";import{N as q,a as G}from"./ListItem-3b929c0f.js";import"./preload-helper-f651ca80.js";import"./p-d5bd0779.js";import"./light-8a4490bb.js";import"./light-90743f8c.js";function X(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!O(e)}const pe=f({name:"PtyView",setup(){let e;const s=m(!1);let o;const i=a=>{e.write(a),e.focus()},r=M(),y=U(),n=R(`${x}/pty`,{timeout:1e4,transports:["websocket"],forceNew:!0,query:{token:P().replace(/^bearer\s/,"")}});n.on("message",({code:a,data:l,type:u})=>{c.emit(u,l,a)}),b(()=>{const a=()=>{e.writeln("PTY connection closed"),r.warning("连接已断开",{closable:!0})};return n.on("disconnect",a),()=>{n.off("disconnect",a)}}),T(()=>{n.offAny(),n.disconnect()}),b(()=>{const a=c.on(p.PTY_MESSAGE,(l,u)=>{if(u===1e4||u===10001){const E=y.create({title:"验证密码",closable:!0,content:()=>t(Z,{onConfirm:S=>{E.destroy(),requestAnimationFrame(()=>{n.emit("pty",Y(e?{cols:e.cols,rows:e.rows}:void 0,{password:S}))})}},null)})}r.info(l)});return()=>{a()}});const N=j(()=>s.value,a=>{a&&(N(),n.emit("pty",{cols:e.cols,rows:e.rows}),o=e.onData(l=>{n.emit("pty-input",l)}),c.on(p.PTY,i))});T(()=>{n.emit("pty-exit"),o?.dispose(),c.off(p.PTY,i)});const h=()=>{if(e&&e.reset(),n.connected===!1){n.io.connect(),setTimeout(()=>{n.connected?n.emit("pty",e?{cols:e.cols,rows:e.rows}:void 0):r.error("重连 Socket 失败")},1500);return}n.emit("pty-exit"),setTimeout(()=>{n.emit("pty",e?{cols:e.cols,rows:e.rows}:void 0)},50)},k=()=>{y.create({title:"连接状态",content:()=>t(z,null,null)})};return()=>t(F,{actionsElement:t(L,null,[t(w,{variant:"info",icon:t(A,null,null),name:"连接状态",onClick:k},null),t(w,{icon:t(D,null,null),name:"重新连接",onClick:h},null)])},{default:()=>[t(B,{class:"!max-h-[calc(100vh-10.5rem)]",darkMode:!0,terminalOptions:{disableStdin:!1},onReady:a=>{s.value=!0,e=a}},null)]})}}),Z=f({props:{onConfirm:Function},setup(e){const s=m(""),o=r=>{r.preventDefault(),e.onConfirm?.(s.value)};g(()=>{requestAnimationFrame(()=>{i.value.focus()})});const i=m();return()=>t($,{onSubmit:o,class:"space-y-6 mt-6"},{default:()=>[t(H,{ref:i,showPasswordOn:"mousedown",type:"password",inputProps:{name:"note-password",autocapitalize:"off",autocomplete:"new-password"},value:s.value,placeholder:"请输入密码",onUpdateValue:r=>{s.value=r}},null),t("div",{class:"flex justify-center"},[t(C,{round:!0,type:"primary",onClick:o},{default:()=>[d("确认")]})])]})}}),z=f(()=>{const e=m([]);return g(async()=>{const s=await I.api.pty.record.get();e.value=s.data}),()=>{let s;return t(_,{bordered:!1,class:"max-h-[70vh] overflow-auto"},{default:()=>[t(q,{bordered:!1,class:"bg-transparent"},X(s=e.value.map(o=>t(G,{key:o.startTime},{default:()=>[t("div",null,[d("开始于 "),v(o.startTime,"yyyy年M月d日 HH:mm:ss")]),t("div",null,[d("IP:")," ",t(V,{trigger:"hover",ip:o.ip,triggerEl:t(C,{text:!0},{default:()=>[o.ip]})},null)]),t("div",null,[o.endTime?`结束于 ${v(o.endTime,"yyyy年M月d日 HH:mm:ss")}`:"没有结束"]),t("div",null,[o.endTime&&`时长：${Math.abs(new Date(o.startTime).getTime()-new Date(o.endTime).getTime())/1e3|0}秒`])]})))?s:{default:()=>[s]})]})}});export{pe as default};
